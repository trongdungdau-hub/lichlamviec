<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n tr·ªã l·ªãch l√†m vi·ªác</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
        body { background: #f0f5fa; min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        
        /* Popup ƒëƒÉng nh·∫≠p */
        .login-popup {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        .login-popup.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .popup-box {
            background: white;
            width: 90%;
            max-width: 450px;
            border-radius: 40px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            text-align: center;
        }
        .popup-row {
            margin: 25px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .popup-row h1 {
            color: #0b2b4b;
            font-size: 28px;
            margin: 0;
        }
        .popup-row input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #cbdae9;
            border-radius: 60px;
            font-size: 18px;
            transition: border-color 0.3s;
        }
        .popup-row input:focus {
            border-color: #2a7faa;
            outline: none;
        }
        .popup-row button {
            background: linear-gradient(145deg, #1b4f72, #144a6f);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 60px;
            font-size: 20px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 15px rgba(0,55,100,0.2);
        }
        .popup-row button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,55,100,0.3);
        }

        /* Ph·∫ßn n·ªôi dung ch√≠nh */
        .main-content {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            display: none;
        }
        .main-content.visible {
            display: block;
        }
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .btn-export {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 40px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-export:hover { background: #218838; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        th { background: #144a6f; color: white; padding: 8px 12px; font-size: 15px; vertical-align: middle; }
        th .day-number {
            display: block;
            font-size: 13px;
            font-weight: 400;
            color: #d0e4f0;
            margin-top: 4px;
        }
        td { padding: 8px; border: 1px solid #dde9f2; vertical-align: middle; text-align: center; }
        .employee-row { background: #f8fcff; }
        .manager-row { background: #fff; }
        .manager-row select { width: 100%; padding: 6px; border-radius: 30px; border: 1px solid #b0c8dd; background: white; }
        .status-pending { background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 30px; font-size: 13px; }
        .status-approved { background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 30px; font-size: 13px; }
        .btn-update { background: #1b4f72; color: white; border: none; padding: 6px 15px; border-radius: 40px; cursor: pointer; font-size: 14px; }
        .btn-update:hover { background: #144a6f; }
        .loading { text-align: center; padding: 40px; font-size: 18px; color: #2a7faa; }
        .week-range {
            font-weight: 600;
            color: #0b2b4b;
        }
    </style>
</head>
<body>

<div id="loginPopup" class="login-popup">
    <div class="popup-box">
        <div class="popup-row">
            <h1>üîê Qu·∫£n tr·ªã l·ªãch l√†m vi·ªác</h1>
        </div>
        <div class="popup-row">
            <input type="password" id="passwordInput" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" value="admin123">
        </div>
        <div class="popup-row">
            <button id="loginBtn">Xem d·ªØ li·ªáu</button>
        </div>
    </div>
</div>

<div id="mainContent" class="main-content">
    <div class="header-bar">
        <h1>üìä D·ªØ li·ªáu ƒëƒÉng k√Ω l·ªãch l√†m vi·ªác</h1>
        <button id="exportBtn" class="btn-export">üì∏ Xu·∫•t b√°o c√°o (ƒë√£ duy·ªát)</button>
    </div>
    <div id="dataArea"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyPaYj1MeoF2p_NaaHmnKO1mG8arsAVMlUSaftBMTKs4d2aye7tqwFq-MISjLE8j6bL/exec';
    const loginPopup = document.getElementById('loginPopup');
    const mainContent = document.getElementById('mainContent');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const dataArea = document.getElementById('dataArea');
    const exportBtn = document.getElementById('exportBtn');

    // √Ånh x·∫° m√£ -> t√™n ti·∫øng Vi·ªát
    const CODE_TO_LABEL = {
        'tu-do': 'T·ª± do',
        'lam-sang': 'L√†m s√°ng',
        'lam-chieu': 'L√†m chi·ªÅu',
        'nua-ca-sang': 'N·ª≠a ca s√°ng',
        'nua-ca-chieu': 'N·ª≠a ca chi·ªÅu',
        'nghi-ca': 'Ngh·ªâ ca',
        'nghi-phep': 'Ngh·ªâ ph√©p'
    };
    const STATUS_CODES = Object.keys(CODE_TO_LABEL);

    /**
     * H√†m t√≠nh m·∫£ng 7 ng√†y d·∫°ng DD/MM t·ª´ ng√†y b·∫Øt ƒë·∫ßu tu·∫ßn
     * ƒê√£ n√¢ng c·∫•p ƒë·ªÉ nh·∫≠n di·ªán m·ªçi ƒë·ªãnh d·∫°ng ng√†y t·ª´ Sheets
     */
    function getDayDates(weekStart) {
        if (!weekStart) return ['', '', '', '', '', '', ''];
        
        let baseDate;

        // X·ª≠ l√Ω ƒë·ªãnh d·∫°ng VN (VD: 15/03/2024)
        if (typeof weekStart === 'string' && weekStart.includes('/')) {
            const datePart = weekStart.split(' ')[0]; 
            const parts = datePart.split('/');
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; 
                const year = parseInt(parts[2], 10);
                baseDate = new Date(year, month, day, 12, 0, 0);
            }
        } 
        // X·ª≠ l√Ω chu·ªói ISO ho·∫∑c YYYY-MM-DD
        else {
            baseDate = new Date(weekStart);
            if (!isNaN(baseDate.getTime())) {
                baseDate.setHours(12, 0, 0, 0); 
            }
        }

        if (!baseDate || isNaN(baseDate.getTime())) {
            return ['', '', '', '', '', '', ''];
        }

        const dates = [];
        for (let i = 0; i < 7; i++) {
            const d = new Date(baseDate);
            d.setDate(baseDate.getDate() + i);
            const dayStr = d.getDate().toString().padStart(2, '0');
            const monthStr = (d.getMonth() + 1).toString().padStart(2, '0');
            dates.push(`${dayStr}/${monthStr}`);
        }
        return dates;
    }

    async function loadData(password) {
        dataArea.innerHTML = '<div class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>';
        try {
            const response = await fetch(`${SCRIPT_URL}?password=${encodeURIComponent(password)}`);
            const data = await response.json();
            if (data.error) {
                dataArea.innerHTML = `<div style="text-align:center;color:#a11f2c;">${data.error}</div>`;
                return;
            }
            if (!Array.isArray(data) || data.length === 0) {
                dataArea.innerHTML = '<p style="text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu.</p>';
                return;
            }
            renderTable(data);
        } catch (e) {
            dataArea.innerHTML = `<div style="text-align:center;color:#a11f2c;">L·ªói k·∫øt n·ªëi: ${e.message}</div>`;
        }
    }

    function renderTable(rows) {
        const firstWeekStart = rows[0]?.['Tu·∫ßn (b·∫Øt ƒë·∫ßu)'] || '';
        const headerDates = getDayDates(firstWeekStart);

        let html = '<table><thead><tr>';
        html += '<th>STT</th>';
        html += '<th>H·ªç t√™n</th>';
        html += '<th>Tu·∫ßn (t·ª´ - ƒë·∫øn)</th>';
        html += `<th>Th·ª© 2<span class="day-number">${headerDates[0]}</span></th>`;
        html += `<th>Th·ª© 3<span class="day-number">${headerDates[1]}</span></th>`;
        html += `<th>Th·ª© 4<span class="day-number">${headerDates[2]}</span></th>`;
        html += `<th>Th·ª© 5<span class="day-number">${headerDates[3]}</span></th>`;
        html += `<th>Th·ª© 6<span class="day-number">${headerDates[4]}</span></th>`;
        html += `<th>Th·ª© 7<span class="day-number">${headerDates[5]}</span></th>`;
        html += `<th>Ch·ªß nh·∫≠t<span class="day-number">${headerDates[6]}</span></th>`;
        html += '<th>Tr·∫°ng th√°i</th>';
        html += '<th></th>';
        html += '</tr></thead><tbody>';
        
        rows.forEach((row, index) => {
            // L·∫•y tr·ª±c ti·∫øp rowIndex t·ª´ server g·ª≠i v·ªÅ (n·∫øu b·∫°n ƒë√£ th√™m obj.rowIndex ·ªü code Script)
            // N·∫øu kh√¥ng c√≥, d·ª± ph√≤ng t√≠nh b·∫±ng index + 2
            const rowIndex = row.rowIndex || (index + 2); 
            const employeeName = row['H·ªç t√™n'] || 'N/A';
            const weekStart = row['Tu·∫ßn (b·∫Øt ƒë·∫ßu)'] || '';
            const day2Code = row['Th·ª© 2'] || 'tu-do';
            const day3Code = row['Th·ª© 3'] || 'tu-do';
            const day4Code = row['Th·ª© 4'] || 'tu-do';
            const day5Code = row['Th·ª© 5'] || 'tu-do';
            const day6Code = row['Th·ª© 6'] || 'tu-do';
            const day7Code = row['Th·ª© 7'] || 'tu-do';
            const dayCnCode = row['Ch·ªß nh·∫≠t'] || 'tu-do';
            const status = row['Tr·∫°ng th√°i'] || 'Ch·ªù duy·ªát';

            const dayDates = getDayDates(weekStart);
            const weekRangeText = (dayDates[0] && dayDates[6]) ? `t·ª´ ${dayDates[0]} ƒë·∫øn ${dayDates[6]}` : weekStart;

            const day2Label = CODE_TO_LABEL[day2Code] || day2Code;
            const day3Label = CODE_TO_LABEL[day3Code] || day3Code;
            const day4Label = CODE_TO_LABEL[day4Code] || day4Code;
            const day5Label = CODE_TO_LABEL[day5Code] || day5Code;
            const day6Label = CODE_TO_LABEL[day6Code] || day6Code;
            const day7Label = CODE_TO_LABEL[day7Code] || day7Code;
            const dayCnLabel = CODE_TO_LABEL[dayCnCode] || dayCnCode;

            // D√≤ng nh√¢n vi√™n
            html += `<tr class="employee-row" data-rowindex="${rowIndex}">`;
            html += `<td>${index + 1}</td>`;
            html += `<td>${employeeName}</td>`;
            html += `<td class="week-range">${weekRangeText}</td>`;
            html += `<td>${day2Label}</td>`;
            html += `<td>${day3Label}</td>`;
            html += `<td>${day4Label}</td>`;
            html += `<td>${day5Label}</td>`;
            html += `<td>${day6Label}</td>`;
            html += `<td>${day7Label}</td>`;
            html += `<td>${dayCnLabel}</td>`;
            html += `<td><span class="${status === 'ƒê√£ duy·ªát' ? 'status-approved' : 'status-pending'}">${status}</span></td>`;
            html += `<td></td></tr>`;

            // D√≤ng qu·∫£n l√Ω (dropdown)
            const createSelect = (selectedCode) => {
                let options = '';
                STATUS_CODES.forEach(code => {
                    const label = CODE_TO_LABEL[code];
                    options += `<option value="${code}" ${code === selectedCode ? 'selected' : ''}>${label}</option>`;
                });
                return `<select class="day-select">${options}</select>`;
            };

            html += `<tr class="manager-row" data-parentrow="${rowIndex}">`;
            html += `<td></td><td></td><td></td>`;
            html += `<td>${createSelect(day2Code)}</td>`;
            html += `<td>${createSelect(day3Code)}</td>`;
            html += `<td>${createSelect(day4Code)}</td>`;
            html += `<td>${createSelect(day5Code)}</td>`;
            html += `<td>${createSelect(day6Code)}</td>`;
            html += `<td>${createSelect(day7Code)}</td>`;
            html += `<td>${createSelect(dayCnCode)}</td>`;
            html += `<td></td>`;
            html += `<td><button class="btn-update" onclick="updateRow(this)" data-rowindex="${rowIndex}">C·∫≠p nh·∫≠t</button></td>`;
            html += `</tr>`;
        });

        html += '</tbody></table>';
        dataArea.innerHTML = html;
    }

    window.updateRow = async function(btn) {
        const rowIndex = btn.dataset.rowindex;
        const managerRow = btn.closest('tr');
        const selects = managerRow.querySelectorAll('.day-select');
        const dayValues = Array.from(selects).map(s => s.value);
        const adminPassword = passwordInput.value.trim();

        if (!adminPassword) { alert('Nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr·ªã'); return; }

        const formData = new URLSearchParams();
        formData.append('action', 'update');
        formData.append('adminPassword', adminPassword);
        formData.append('rowIndex', rowIndex);
        formData.append('day2', dayValues[0]);
        formData.append('day3', dayValues[1]);
        formData.append('day4', dayValues[2]);
        formData.append('day5', dayValues[3]);
        formData.append('day6', dayValues[4]);
        formData.append('day7', dayValues[5]);
        formData.append('dayCn', dayValues[6]);

        try {
            // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang c·∫≠p nh·∫≠t
            const originalText = btn.textContent;
            btn.textContent = 'ƒêang l∆∞u...';
            btn.disabled = true;

            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            
            if (result.success) {
                alert('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
                loadData(adminPassword); // T·∫£i l·∫°i b·∫£ng ƒë·ªÉ th·∫•y ch·ªØ "ƒê√£ duy·ªát"
            } else {
                alert('L·ªói: ' + (result.error || 'Kh√¥ng x√°c ƒë·ªãnh'));
                btn.textContent = originalText;
                btn.disabled = false;
            }
        } catch (e) {
            alert('L·ªói k·∫øt n·ªëi: ' + e.message);
            btn.textContent = 'C·∫≠p nh·∫≠t';
            btn.disabled = false;
        }
    };

    // Xu·∫•t b√°o c√°o
    exportBtn.addEventListener('click', function() {
        const approvedRows = document.querySelectorAll('.employee-row .status-approved');
        if (approvedRows.length === 0) {
            alert('Kh√¥ng c√≥ d√≤ng n√†o ƒë√£ duy·ªát ƒë·ªÉ xu·∫•t b√°o c√°o.');
            return;
        }

        const rowsToExport = [];
        document.querySelectorAll('.employee-row').forEach(row => {
            const statusSpan = row.querySelector('.status-approved');
            if (statusSpan) {
                rowsToExport.push(row);
            }
        });

        const tempTable = document.createElement('table');
        tempTable.style.borderCollapse = 'collapse';
        tempTable.style.width = '100%';
        tempTable.style.background = 'white';
        tempTable.style.fontSize = '14px';

        const headerRow = document.querySelector('table thead tr').cloneNode(true);
        headerRow.deleteCell(-1); // B·ªè c·ªôt cu·ªëi (n√∫t c·∫≠p nh·∫≠t)
        tempTable.appendChild(headerRow);

        rowsToExport.forEach(row => {
            const clonedRow = row.cloneNode(true);
            clonedRow.deleteCell(-1); // B·ªè c·ªôt cu·ªëi
            tempTable.appendChild(clonedRow);
        });

        tempTable.style.position = 'absolute';
        tempTable.style.left = '-9999px';
        document.body.appendChild(tempTable);

        // ƒê·ªïi sang hi·ªáu ·ª©ng hi·ªÉn th·ªã t·∫£i ·∫£nh
        const originalText = exportBtn.textContent;
        exportBtn.textContent = 'üì∏ ƒêang t·∫°o ·∫£nh...';

        html2canvas(tempTable, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
            // T√≠nh chu·ªói ng√†y th√°ng nƒÉm theo gi·ªù ƒë·ªãa ph∆∞∆°ng (Tr√°nh l·ªói l√πi ng√†y c·ªßa toISOString)
            const today = new Date();
            const localDateStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            const link = document.createElement('a');
            link.download = `bao-cao-da-duyet-${localDateStr}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            
            document.body.removeChild(tempTable);
            exportBtn.textContent = originalText;
        }).catch(error => {
            console.error('L·ªói khi ch·ª•p ·∫£nh:', error);
            alert('C√≥ l·ªói khi xu·∫•t b√°o c√°o.');
            document.body.removeChild(tempTable);
            exportBtn.textContent = originalText;
        });
    });

    loginBtn.addEventListener('click', () => {
        const pwd = passwordInput.value.trim();
        if (!pwd) {
            alert('Nh·∫≠p m·∫≠t kh·∫©u');
            return;
        }
        loginPopup.classList.add('hidden');
        mainContent.classList.add('visible');
        loadData(pwd);
    });

    passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            loginBtn.click();
        }
    });
</script>
</body>
</html>
