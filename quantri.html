<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n tr·ªã l·ªãch l√†m vi·ªác</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f0f5fa; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #0b2b4b; }
        .login { background: white; border-radius: 60px; padding: 20px; margin-bottom: 30px; display: flex; gap: 15px; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .login input { flex: 1; padding: 12px 20px; border: 2px solid #cbdae9; border-radius: 40px; font-size: 16px; }
        .login button { background: #1b4f72; color: white; border: none; padding: 12px 30px; border-radius: 40px; font-size: 16px; cursor: pointer; }
        .login button:hover { background: #144a6f; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        th { background: #144a6f; color: white; padding: 12px; font-size: 15px; }
        td { padding: 8px; border: 1px solid #dde9f2; vertical-align: middle; }
        .employee-row { background: #f8fcff; }
        .manager-row { background: #fff; }
        .employee-row td { font-weight: 500; color: #0b2b4b; }
        .manager-row select { width: 100%; padding: 6px; border-radius: 30px; border: 1px solid #b0c8dd; background: white; }
        .status-pending { background: #fff3cd; color: #856404; padding: 4px 8px; border-radius: 30px; font-size: 13px; }
        .status-approved { background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 30px; font-size: 13px; }
        .btn-update { background: #1b4f72; color: white; border: none; padding: 6px 15px; border-radius: 40px; cursor: pointer; font-size: 14px; }
        .btn-update:hover { background: #144a6f; }
        .message { background: #d1ecf1; color: #0c5460; padding: 12px; border-radius: 60px; margin-top: 20px; display: none; }
        .error { background: #f8d7da; color: #a11f2c; }
        .loading { text-align: center; padding: 40px; font-size: 18px; color: #2a7faa; }
    </style>
</head>
<body>
<div class="container">
    <h1>üîê Qu·∫£n tr·ªã l·ªãch l√†m vi·ªác</h1>
    <div class="login">
        <input type="password" id="passwordInput" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" value="admin123">
        <button id="loginBtn">Xem d·ªØ li·ªáu</button>
    </div>
    <div id="dataArea"></div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyPaYj1MeoF2p_NaaHmnKO1mG8arsAVMlUSaftBMTKs4d2aye7tqwFq-MISjLE8j6bL/exec';
    const loginBtn = document.getElementById('loginBtn');
    const passwordInput = document.getElementById('passwordInput');
    const dataArea = document.getElementById('dataArea');

    // √Ånh x·∫° t·ª´ m√£ (trong sheet) sang t√™n ti·∫øng Vi·ªát hi·ªÉn th·ªã
    const CODE_TO_LABEL = {
        'tu-do': 'T·ª± do',
        'lam-sang': 'L√†m s√°ng',
        'lam-chieu': 'L√†m chi·ªÅu',
        'nua-ca-sang': 'N·ª≠a ca s√°ng',
        'nua-ca-chieu': 'N·ª≠a ca chi·ªÅu',
        'nghi-ca': 'Ngh·ªâ ca',
        'nghi-phep': 'Ngh·ªâ ph√©p'
    };

    // Danh s√°ch c√°c m√£ (d√πng ƒë·ªÉ t·∫°o dropdown, value l√† m√£, text l√† nh√£n)
    const STATUS_CODES = Object.keys(CODE_TO_LABEL);

    async function loadData(password) {
        dataArea.innerHTML = '<div class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>';
        try {
            const response = await fetch(`${SCRIPT_URL}?password=${encodeURIComponent(password)}`);
            const data = await response.json();
            if (data.error) {
                dataArea.innerHTML = `<div class="message error">${data.error}</div>`;
                return;
            }
            if (!Array.isArray(data) || data.length === 0) {
                dataArea.innerHTML = '<p>Ch∆∞a c√≥ d·ªØ li·ªáu.</p>';
                return;
            }
            renderTable(data);
        } catch (e) {
            dataArea.innerHTML = `<div class="message error">L·ªói k·∫øt n·ªëi: ${e.message}</div>`;
        }
    }

    function renderTable(rows) {
        let html = '<table><thead><tr><th>STT</th><th>H·ªç t√™n</th><th>Tu·∫ßn</th><th>Th·ª© 2</th><th>Th·ª© 3</th><th>Th·ª© 4</th><th>Th·ª© 5</th><th>Th·ª© 6</th><th>Th·ª© 7</th><th>Ch·ªß nh·∫≠t</th><th>Tr·∫°ng th√°i</th><th></th></tr></thead><tbody>';
        
        rows.forEach((row, index) => {
            const rowIndex = index + 2; // D√≤ng th·ª±c t·∫ø trong sheet (v√¨ d√≤ng 1 l√† header)
            const employeeName = row['H·ªç t√™n'] || 'N/A';
            const weekStart = row['Tu·∫ßn (b·∫Øt ƒë·∫ßu)'] || '';
            // L·∫•y m√£ t·ª´ sheet, n·∫øu kh√¥ng c√≥ th√¨ m·∫∑c ƒë·ªãnh 'tu-do'
            const day2Code = row['Th·ª© 2'] || 'tu-do';
            const day3Code = row['Th·ª© 3'] || 'tu-do';
            const day4Code = row['Th·ª© 4'] || 'tu-do';
            const day5Code = row['Th·ª© 5'] || 'tu-do';
            const day6Code = row['Th·ª© 6'] || 'tu-do';
            const day7Code = row['Th·ª© 7'] || 'tu-do';
            const dayCnCode = row['Ch·ªß nh·∫≠t'] || 'tu-do';
            const status = row['Tr·∫°ng th√°i'] || 'Ch·ªù duy·ªát';

            // Chuy·ªÉn m√£ sang nh√£n ti·∫øng Vi·ªát ƒë·ªÉ hi·ªÉn th·ªã
            const day2Label = CODE_TO_LABEL[day2Code] || day2Code;
            const day3Label = CODE_TO_LABEL[day3Code] || day3Code;
            const day4Label = CODE_TO_LABEL[day4Code] || day4Code;
            const day5Label = CODE_TO_LABEL[day5Code] || day5Code;
            const day6Label = CODE_TO_LABEL[day6Code] || day6Code;
            const day7Label = CODE_TO_LABEL[day7Code] || day7Code;
            const dayCnLabel = CODE_TO_LABEL[dayCnCode] || dayCnCode;
            
            // D√≤ng nh√¢n vi√™n (d·ªØ li·ªáu g·ªëc, hi·ªÉn th·ªã b·∫±ng ti·∫øng Vi·ªát)
            html += `<tr class="employee-row" data-rowindex="${rowIndex}">`;
            html += `<td>${index + 1}</td>`;
            html += `<td>${employeeName}</td>`;
            html += `<td>${weekStart}</td>`;
            html += `<td>${day2Label}</td><td>${day3Label}</td><td>${day4Label}</td><td>${day5Label}</td><td>${day6Label}</td><td>${day7Label}</td><td>${dayCnLabel}</td>`;
            html += `<td><span class="${status === 'ƒê√£ duy·ªát' ? 'status-approved' : 'status-pending'}">${status}</span></td>`;
            html += `<td></td></tr>`;

            // D√≤ng qu·∫£n l√Ω (dropdown ƒë·ªÉ ch·ªânh s·ª≠a) - value l√† m√£, text l√† nh√£n
            const createSelect = (selectedCode) => {
                let options = '';
                STATUS_CODES.forEach(code => {
                    const label = CODE_TO_LABEL[code];
                    options += `<option value="${code}" ${code === selectedCode ? 'selected' : ''}>${label}</option>`;
                });
                return `<select class="day-select">${options}</select>`;
            };

            html += `<tr class="manager-row" data-parentrow="${rowIndex}">`;
            html += `<td></td><td></td><td></td>`; // STT, H·ªç t√™n, Tu·∫ßn ƒë·ªÉ tr·ªëng
            html += `<td>${createSelect(day2Code)}</td>`;
            html += `<td>${createSelect(day3Code)}</td>`;
            html += `<td>${createSelect(day4Code)}</td>`;
            html += `<td>${createSelect(day5Code)}</td>`;
            html += `<td>${createSelect(day6Code)}</td>`;
            html += `<td>${createSelect(day7Code)}</td>`;
            html += `<td>${createSelect(dayCnCode)}</td>`;
            html += `<td></td>`;
            html += `<td><button class="btn-update" onclick="updateRow(this)" data-rowindex="${rowIndex}">C·∫≠p nh·∫≠t</button></td>`;
            html += `</tr>`;
        });

        html += '</tbody></table>';
        dataArea.innerHTML = html;
    }

    window.updateRow = async function(btn) {
        const rowIndex = btn.dataset.rowindex;
        const managerRow = btn.closest('tr');
        const selects = managerRow.querySelectorAll('.day-select');
        // L·∫•y value (m√£) t·ª´ c√°c dropdown
        const dayValues = Array.from(selects).map(s => s.value);
        const adminPassword = passwordInput.value.trim();

        if (!adminPassword) { alert('Nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr·ªã'); return; }

        const formData = new URLSearchParams();
        formData.append('action', 'update');
        formData.append('adminPassword', adminPassword);
        formData.append('rowIndex', rowIndex);
        formData.append('day2', dayValues[0]);
        formData.append('day3', dayValues[1]);
        formData.append('day4', dayValues[2]);
        formData.append('day5', dayValues[3]);
        formData.append('day6', dayValues[4]);
        formData.append('day7', dayValues[5]);
        formData.append('dayCn', dayValues[6]);

        try {
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (result.success) {
                alert('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
                loadData(adminPassword); // T·∫£i l·∫°i d·ªØ li·ªáu ƒë·ªÉ th·∫•y thay ƒë·ªïi
            } else {
                alert('L·ªói: ' + (result.error || 'Kh√¥ng x√°c ƒë·ªãnh'));
            }
        } catch (e) {
            alert('L·ªói k·∫øt n·ªëi: ' + e.message);
        }
    };

    loginBtn.addEventListener('click', () => {
        const pwd = passwordInput.value.trim();
        if (!pwd) { alert('Nh·∫≠p m·∫≠t kh·∫©u'); return; }
        loadData(pwd);
    });

    passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loginBtn.click();
    });
</script>
</body>
</html>
