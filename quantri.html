<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n tr·ªã L·ªãch L√†m Vi·ªác</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb; 
            --primary-hover: #1d4ed8;
            --bg-body: #f8fafc;
            --surface: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-light: #e2e8f0;
            --success-bg: #dcfce7;
            --success-text: #15803d;
            --warning-bg: #fef3c7;
            --warning-text: #b45309;
            --total-bg: #eff6ff;
            --total-text: #1d4ed8;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        body { background-color: var(--bg-body); color: var(--text-main); min-height: 100vh; padding: 30px 20px; }

        /* ----- POPUP ƒêƒÇNG NH·∫¨P ----- */
        .login-popup {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center; z-index: 1000; transition: opacity 0.3s ease;
        }
        .login-popup.hidden { opacity: 0; pointer-events: none; }
        .popup-box {
            background: var(--surface); width: 100%; max-width: 400px; border-radius: 24px; padding: 40px 32px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); text-align: center;
        }
        .popup-box h1 { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .popup-box p { color: var(--text-muted); font-size: 14px; margin-bottom: 24px; }
        .popup-box input {
            width: 100%; padding: 14px 20px; border: 2px solid var(--border-light); border-radius: 12px; font-size: 16px;
            outline: none; background: #f8fafc; margin-bottom: 24px;
        }
        .popup-box input:focus { border-color: var(--primary); background: #fff; }
        .popup-box button {
            width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .popup-box button:hover { background: var(--primary-hover); }

        /* ----- LAYOUT CH√çNH ----- */
        .main-content { width: 100%; max-width: 1600px; margin: 0 auto; display: none; }
        .main-content.visible { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        .header-bar h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
        
        .export-group { display: flex; gap: 12px; }
        .btn-export-img {
            background: white; color: var(--text-main); border: 1px solid var(--border-light); padding: 10px 20px; border-radius: 10px;
            font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .btn-export-img:hover { background: #f1f5f9; }
        
        .btn-export-excel {
            background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 10px;
            font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2); transition: 0.2s;
        }
        .btn-export-excel:hover { background: #059669; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(16, 185, 129, 0.3); }

        /* ----- B·∫¢NG D·ªÆ LI·ªÜU ----- */
        .table-container { background: var(--surface); border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border-light); overflow-x: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; text-align: center; }
        th, td { padding: 12px; border-bottom: 1px solid var(--border-light); vertical-align: middle; }
        th { background: #f8fafc; color: var(--text-muted); font-size: 13px; font-weight: 600; text-transform: uppercase; white-space: nowrap; }
        th .day-number { display: block; font-size: 12px; color: var(--primary); margin-top: 4px; font-weight: 700; }
        
        .employee-row td { font-size: 14px; font-weight: 500; background: #fff; }
        .manager-row td { background-color: #f1f5f9; border-bottom: 3px solid #cbd5e1; }

        .total-cell { font-weight: 700; color: var(--total-text); background: var(--total-bg); border-radius: 8px; font-size: 15px; }
        .week-range { font-weight: 600; font-size: 13px; color: var(--text-muted); white-space: nowrap; }

        /* ----- UI CH·ªåN GI·ªú (DROPDOWNS) ----- */
        .time-blocks-container { display: flex; flex-direction: column; gap: 6px; align-items: center; }
        .time-block { display: flex; align-items: center; gap: 4px; background: white; padding: 4px; border-radius: 6px; border: 1px solid #cbd5e1; }
        .time-block select {
            padding: 4px 2px; border: none; background: transparent; font-size: 13px; font-weight: 600;
            color: var(--text-main); cursor: pointer; outline: none; appearance: none; text-align: center;
        }
        .time-block span { font-weight: bold; color: #94a3b8; }
        .btn-add-split {
            background: #e2e8f0; color: #475569; border: none; border-radius: 4px; padding: 2px 8px;
            font-size: 12px; font-weight: bold; cursor: pointer; margin-top: 4px; transition: 0.2s;
        }
        .btn-add-split:hover { background: #cbd5e1; }
        .btn-remove-split { background: transparent; color: #ef4444; border: none; font-size: 16px; cursor: pointer; line-height: 1; padding: 0 4px; }

        /* ----- N√öT & TR·∫†NG TH√ÅI ----- */
        .btn-update { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .btn-update:hover { background: var(--primary-hover); }
        .status-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; white-space: nowrap; }
        .status-pending { background: var(--warning-bg); color: var(--warning-text); }
        .status-approved { background: var(--success-bg); color: var(--success-text); }
        .loading { text-align: center; padding: 60px; color: var(--text-muted); font-weight: 500; }
    </style>
</head>
<body>

<div id="loginPopup" class="login-popup">
    <div class="popup-box">
        <h1>Qu·∫£n tr·ªã h·ªá th·ªëng</h1>
        <p>Vui l√≤ng nh·∫≠p m·∫≠t m√£ ƒë·ªÉ truy c·∫≠p d·ªØ li·ªáu</p>
        <input type="password" id="passwordInput" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" value="admin123">
        <button id="loginBtn">ƒêƒÉng nh·∫≠p</button>
    </div>
</div>

<div id="mainContent" class="main-content">
    <div class="header-bar">
        <h1>Qu·∫£n L√Ω Gi·ªù L√†m Vi·ªác</h1>
        <div class="export-group">
            <button id="exportImgBtn" class="btn-export-img">üì∏ Xu·∫•t ·∫¢nh</button>
            <button id="exportExcelBtn" class="btn-export-excel">üìä Xu·∫•t Excel</button>
        </div>
    </div>
    <div id="dataArea" class="table-container"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyPaYj1MeoF2p_NaaHmnKO1mG8arsAVMlUSaftBMTKs4d2aye7tqwFq-MISjLE8j6bL/exec';
    
    const loginPopup = document.getElementById('loginPopup');
    const mainContent = document.getElementById('mainContent');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const dataArea = document.getElementById('dataArea');
    const exportImgBtn = document.getElementById('exportImgBtn');
    const exportExcelBtn = document.getElementById('exportExcelBtn');

    // M·∫£ng ch·ª©a c√°c m·ªëc th·ªùi gian t·ª´ 06:00 ƒë·∫øn 24:00 (M·ªói 15 ph√∫t)
    const TIME_OPTIONS = ['Ngh·ªâ'];
    for(let h = 6; h <= 24; h++) {
        let hour = h.toString().padStart(2, '0');
        TIME_OPTIONS.push(`${hour}:00`);
        if(h !== 24) {
            TIME_OPTIONS.push(`${hour}:15`);
            TIME_OPTIONS.push(`${hour}:30`);
            TIME_OPTIONS.push(`${hour}:45`);
        }
    }

    const CODE_TO_LABEL = {
        'tu-do':'T·ª± do', 'lam-sang':'L√†m s√°ng', 'lam-chieu':'L√†m chi·ªÅu',
        'nua-ca-sang':'N·ª≠a ca s√°ng', 'nua-ca-chieu':'N·ª≠a ca chi·ªÅu', 'nghi-ca':'Ngh·ªâ ca', 'nghi-phep':'Ngh·ªâ ph√©p'
    };

    function getDayDates(weekStart) {
        if (!weekStart) return Array(7).fill('');
        let baseDate;
        if (typeof weekStart === 'string' && weekStart.includes('T')) {
            baseDate = new Date(weekStart); baseDate.setHours(12, 0, 0, 0); 
        } else {
            let parts = (weekStart.split(' ')[0] || '').split('-');
            if (parts.length === 3) baseDate = new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10), 12, 0, 0);
        }
        if (!baseDate || isNaN(baseDate.getTime())) return Array(7).fill('');
        
        let dates = [];
        for (let i = 0; i < 7; i++) {
            let d = new Date(baseDate); d.setDate(baseDate.getDate() + i);
            dates.push(`${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}`);
        }
        return dates;
    }

    window.calculateTotalHours = function(managerRow) {
        let totalHours = 0;
        const timeBlocks = managerRow.querySelectorAll('.time-block');
        
        timeBlocks.forEach(block => {
            const startStr = block.querySelector('.t-start').value;
            const endStr = block.querySelector('.t-end').value;
            
            if(startStr !== 'Ngh·ªâ' && endStr !== 'Ngh·ªâ' && startStr && endStr) {
                let [sH, sM] = startStr.split(':').map(Number);
                let [eH, eM] = endStr.split(':').map(Number);
                let startDec = sH + (sM / 60);
                let endDec = eH + (eM / 60);
                if(endDec > startDec) totalHours += (endDec - startDec);
            }
        });
        return totalHours;
    };

    window.updateTotalOnChange = function(el) {
        const row = el.closest('tr');
        const totalCell = row.querySelector('.total-hours-edit');
        if (totalCell) totalCell.textContent = window.calculateTotalHours(row) + "h";
    };

    window.addTimeBlock = function(btn) {
        const container = btn.previousElementSibling;
        const div = document.createElement('div');
        div.className = 'time-block';
        div.innerHTML = createTimeSelects('', '') + `<button class="btn-remove-split" onclick="this.parentElement.remove(); window.updateTotalOnChange(this)">√ó</button>`;
        container.appendChild(div);
    };

    function createTimeSelects(startVal, endVal) {
        let optsStart = TIME_OPTIONS.map(t => `<option value="${t}" ${t===startVal?'selected':''}>${t}</option>`).join('');
        let optsEnd = TIME_OPTIONS.map(t => `<option value="${t}" ${t===endVal?'selected':''}>${t}</option>`).join('');
        return `<select class="t-start" onchange="window.updateTotalOnChange(this)">${optsStart}</select>
                <span>-</span>
                <select class="t-end" onchange="window.updateTotalOnChange(this)">${optsEnd}</select>`;
    }

    function buildManagerCell(existingValue) {
        let blocksHTML = '';
        if(!existingValue || existingValue === 'Ngh·ªâ' || CODE_TO_LABEL[existingValue]) {
            blocksHTML = `<div class="time-block">${createTimeSelects('Ngh·ªâ', 'Ngh·ªâ')}</div>`;
        } else {
            let blocks = existingValue.split(',');
            blocks.forEach((blk, idx) => {
                let times = blk.split('-');
                let s = times[0] ? times[0].trim() : 'Ngh·ªâ';
                let e = times[1] ? times[1].trim() : 'Ngh·ªâ';
                blocksHTML += `<div class="time-block">${createTimeSelects(s, e)}`;
                if(idx > 0) blocksHTML += `<button class="btn-remove-split" onclick="this.parentElement.remove(); window.updateTotalOnChange(this)">√ó</button>`;
                blocksHTML += `</div>`;
            });
        }
        return `<div class="time-blocks-container">${blocksHTML}</div><button class="btn-add-split" onclick="addTimeBlock(this)" title="Th√™m ca g√£y">+</button>`;
    }

    async function loadData(password) {
        dataArea.innerHTML = '<div class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>';
        try {
            const response = await fetch(`${SCRIPT_URL}?password=${encodeURIComponent(password)}`);
            const data = await response.json();
            if (data.error) { dataArea.innerHTML = `<div class="loading" style="color:red;">L·ªói: ${data.error}</div>`; return; }
            if (!Array.isArray(data) || data.length === 0) { dataArea.innerHTML = '<div class="loading">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>'; return; }
            renderTable(data);
        } catch (e) { dataArea.innerHTML = `<div class="loading" style="color:red;">L·ªói k·∫øt n·ªëi: ${e.message}</div>`; }
    }

    function renderTable(rows) {
        const headerDates = getDayDates(rows[0]?.['Tu·∫ßn (b·∫Øt ƒë·∫ßu)'] || '');
        let html = '<table><thead><tr>';
        html += '<th>STT</th><th>H·ªç t√™n</th><th>Tu·∫ßn</th>';
        ['Th·ª© 2','Th·ª© 3','Th·ª© 4','Th·ª© 5','Th·ª© 6','Th·ª© 7','Ch·ªß nh·∫≠t'].forEach((day, i) => {
            html += `<th>${day}<span class="day-number">${headerDates[i]}</span></th>`;
        });
        html += '<th>T·ªïng Gi·ªù</th><th>Tr·∫°ng th√°i</th><th>Thao t√°c</th></tr></thead><tbody>';
        
        rows.forEach((row, index) => {
            const rowIndex = row.rowIndex || (index + 2); 
            const codes = ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7', 'Ch·ªß nh·∫≠t'].map(d => row[d] || '');
            const status = row['Tr·∫°ng th√°i'] || 'Ch·ªù duy·ªát';
            const dayDates = getDayDates(row['Tu·∫ßn (b·∫Øt ƒë·∫ßu)'] || '');
            const weekText = (dayDates[0] && dayDates[6]) ? `${dayDates[0]}-${dayDates[6]}` : row['Tu·∫ßn (b·∫Øt ƒë·∫ßu)'];

            // D√≤ng hi·ªÉn th·ªã nguy·ªán v·ªçng
            html += `<tr class="employee-row">`;
            html += `<td>${index + 1}</td><td style="font-weight:700;">${row['H·ªç t√™n'] || 'N/A'}</td><td class="week-range">${weekText}</td>`;
            codes.forEach(c => {
                let label = CODE_TO_LABEL[c] ? CODE_TO_LABEL[c] : c; 
                html += `<td style="color:#64748b; font-size:12px;">${label}</td>`;
            });
            html += `<td></td><td><span class="status-badge ${status === 'ƒê√£ duy·ªát' ? 'status-approved' : 'status-pending'}">${status}</span></td><td></td></tr>`;

            // D√≤ng qu·∫£n l√Ω ch·ªët gi·ªù
            html += `<tr class="manager-row" data-rowindex="${rowIndex}"><td></td><td style="color:#0f172a; font-weight:600; font-size:13px; text-align:right;">Ch·ªët gi·ªù:</td><td></td>`;
            codes.forEach(c => { html += `<td>${buildManagerCell(c)}</td>`; });
            html += `<td class="total-cell total-hours-edit">0h</td><td></td>`;
            html += `<td><button class="btn-update" onclick="updateRow(this)" data-rowindex="${rowIndex}">L∆∞u Duy·ªát</button></td></tr>`;
        });

        html += '</tbody></table>';
        dataArea.innerHTML = html;

        document.querySelectorAll('.manager-row').forEach(row => {
            row.querySelector('.total-hours-edit').textContent = window.calculateTotalHours(row) + "h";
        });
    }

    window.updateRow = async function(btn) {
        const row = btn.closest('tr');
        const rowIndex = btn.dataset.rowindex;
        const adminPassword = passwordInput.value.trim();
        const cells = row.querySelectorAll('td');
        const dayValues = [];
        
        for(let i = 3; i <= 9; i++) {
            let blocks = cells[i].querySelectorAll('.time-block');
            let dayStrArr = [];
            blocks.forEach(blk => {
                let s = blk.querySelector('.t-start').value;
                let e = blk.querySelector('.t-end').value;
                if(s !== 'Ngh·ªâ' && e !== 'Ngh·ªâ') dayStrArr.push(`${s}-${e}`);
            });
            dayValues.push(dayStrArr.length > 0 ? dayStrArr.join(', ') : 'Ngh·ªâ');
        }

        try {
            btn.textContent = 'ƒêang l∆∞u...'; btn.disabled = true;
            const formData = new URLSearchParams({ action: 'update', adminPassword, rowIndex, 
                day2: dayValues[0], day3: dayValues[1], day4: dayValues[2], day5: dayValues[3], day6: dayValues[4], day7: dayValues[5], dayCn: dayValues[6] 
            });
            const response = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
            const result = await response.json();
            
            if (result.success) { loadData(adminPassword); } 
            else { alert('L·ªói: ' + result.error); btn.textContent = 'L∆∞u Duy·ªát'; btn.disabled = false; }
        } catch (e) { alert('L·ªói h·ªá th·ªëng: ' + e.message); btn.textContent = 'L∆∞u Duy·ªát'; btn.disabled = false; }
    };

    // ================= XU·∫§T ·∫¢NH B√ÅO C√ÅO NHANH =================
    exportImgBtn.addEventListener('click', function() {
        const rowsToExport = Array.from(document.querySelectorAll('.employee-row')).filter(r => r.querySelector('.status-approved'));
        if (!rowsToExport.length) return alert('Kh√¥ng c√≥ d√≤ng n√†o ƒë√£ duy·ªát ƒë·ªÉ xu·∫•t ·∫£nh.');

        const tempTable = document.createElement('table');
        tempTable.style.cssText = 'border-collapse: collapse; width: 100%; background: #ffffff; color: #000000; font-family: sans-serif; text-align: center;';
        
        const headerRow = document.querySelector('table thead tr').cloneNode(true);
        headerRow.deleteCell(-1); 
        Array.from(headerRow.cells).forEach(c => c.style.cssText = 'padding:12px; border: 1px solid #cbd5e1; background: #f8fafc; font-weight: bold;');
        tempTable.appendChild(headerRow);

        rowsToExport.forEach(row => {
            const clonedRow = row.cloneNode(true);
            clonedRow.deleteCell(-1); 
            Array.from(clonedRow.cells).forEach(c => {
                c.style.cssText = 'padding:12px; border: 1px solid #cbd5e1;';
                const badge = c.querySelector('.status-badge');
                if (badge) badge.style.cssText = 'color: #15803d; font-weight: bold;';
            });
            tempTable.appendChild(clonedRow);
        });

        Object.assign(tempTable.style, { position: 'absolute', left: '-9999px' });
        document.body.appendChild(tempTable);
        
        const oldText = exportImgBtn.innerText;
        exportImgBtn.innerText = '‚è≥ ƒêang t·∫°o ·∫£nh...';

        html2canvas(tempTable, { scale: 2, backgroundColor: '#ffffff' }).then(canvas => {
            const link = document.createElement('a');
            link.download = `Lich-Lam-Viec-${new Date().toISOString().slice(0,10)}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            document.body.removeChild(tempTable);
            exportImgBtn.innerText = oldText;
        });
    });

    // ================= XU·∫§T EXCEL GANTT CHART =================
    exportExcelBtn.addEventListener('click', async function() {
        try {
            exportExcelBtn.innerHTML = '‚è≥ ƒêang t·∫°o Excel...';
            
            const workbook = new ExcelJS.Workbook();
            const dayNames = ['Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7', 'Ch·ªß nh·∫≠t'];
            
            const employees = [];
            document.querySelectorAll('.employee-row').forEach(empRow => {
                const rowIndex = empRow.nextElementSibling.dataset.rowindex;
                const name = empRow.cells[1].innerText;
                const status = empRow.querySelector('.status-badge').innerText;
                if(status !== 'ƒê√£ duy·ªát') return;

                const mgrRow = document.querySelector(`.manager-row[data-rowindex="${rowIndex}"]`);
                const dayTimes = [];
                for (let i = 3; i <= 9; i++) {
                    const cell = mgrRow.cells[i];
                    const blocks = cell.querySelectorAll('.time-block');
                    const times = [];
                    blocks.forEach(blk => {
                        const s = blk.querySelector('.t-start').value;
                        const e = blk.querySelector('.t-end').value;
                        if (s !== 'Ngh·ªâ' && e !== 'Ngh·ªâ') times.push({ start: s, end: e });
                    });
                    dayTimes.push(times);
                }
                employees.push({ name, dayTimes });
            });

            if(employees.length === 0) {
                alert("Kh√¥ng c√≥ nh√¢n vi√™n n√†o 'ƒê√£ duy·ªát' ƒë·ªÉ xu·∫•t Excel!");
                exportExcelBtn.innerHTML = 'üìä Xu·∫•t Excel';
                return;
            }

            dayNames.forEach((dayName, dayIndex) => {
                const sheet = workbook.addWorksheet(dayName);

                // T·∫°o ti√™u ƒë·ªÅ t·ª´ 06:00 ƒë·∫øn 24:00 (m·ªói 15 ph√∫t)
                const headerRow = ['STT', 'H·ªç t√™n', 'Khung gi·ªù'];
                for(let h = 6; h <= 24; h++) {
                    let hh = h.toString().padStart(2, '0');
                    headerRow.push(`${hh}:00`);
                    if(h !== 24) {
                        headerRow.push(`${hh}:15`, `${hh}:30`, `${hh}:45`);
                    }
                }
                const header = sheet.addRow(headerRow);
                
                // Style Header (Xoay d·ªçc ch·ªØ 90 ƒë·ªô cho c√°c c·ªôt gi·ªù)
                header.eachCell((cell, colNumber) => {
                    cell.font = { bold: true };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE2E8F0' } };
                    cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                    if (colNumber > 3) {
                        // C·ªôt th·ªùi gian: Quay ch·ªØ d·ªçc 90 ƒë·ªô
                        cell.alignment = { horizontal: 'center', vertical: 'middle', textRotation: 90 };
                    } else {
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    }
                });

                sheet.getColumn(1).width = 5;
                sheet.getColumn(2).width = 25;
                sheet.getColumn(3).width = 20;
                // T·ªïng c·ªông c√≥ 73 c·ªôt th·ªùi gian (t·ª´ c·ªôt 4 ƒë·∫øn c·ªôt 76)
                for(let i = 4; i <= 76; i++) {
                    sheet.getColumn(i).width = 3.5; // C·ªôt si√™u h·∫πp ƒë·ªÉ t·∫°o d·∫£i bƒÉng Gantt
                }

                // ƒêi·ªÅn d·ªØ li·ªáu
                employees.forEach((emp, index) => {
                    const row = [index + 1, emp.name];
                    const times = emp.dayTimes[dayIndex];
                    
                    let timeStr = times.map(t => `${t.start} - ${t.end}`).join(', ') || 'Ngh·ªâ';
                    row.push(timeStr);

                    // 73 c·ªôt tr·ªëng ƒë·ªÉ chu·∫©n b·ªã t√¥ m√†u
                    for(let i=0; i<73; i++) row.push('');
                    
                    const sheetRow = sheet.addRow(row);
                    
                    for(let i=1; i<=3; i++) {
                        sheetRow.getCell(i).border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                        sheetRow.getCell(i).alignment = { vertical: 'middle' };
                    }

                    if(times.length > 0) {
                        times.forEach(t => {
                            let [sH, sM] = t.start.split(':').map(Number);
                            let [eH, eM] = t.end.split(':').map(Number);
                            
                            // T√≠nh v·ªã tr√≠ b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c (B∆∞·ªõc nh·∫£y 15 ph√∫t)
                            // 06:00 n·∫±m ·ªü c·ªôt s·ªë 4
                            let startIndex = (sH - 6) * 4 + (sM / 15) + 4; 
                            let endIndex = (eH - 6) * 4 + (eM / 15) + 4;

                            for(let c = startIndex; c < endIndex; c++) {
                                const cell = sheetRow.getCell(c);
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2563EB' } };
                                cell.border = { top: {style:'thin'}, bottom: {style:'thin'} }; 
                            }
                            if (startIndex < 77) sheetRow.getCell(startIndex).border = { left: {style:'thin'}, top: {style:'thin'}, bottom: {style:'thin'} };
                            if (endIndex - 1 < 77 && endIndex > 4) sheetRow.getCell(endIndex - 1).border = { right: {style:'thin'}, top: {style:'thin'}, bottom: {style:'thin'} };
                        });
                    } else {
                        for(let c = 4; c <= 76; c++) {
                            sheetRow.getCell(c).border = { top: {style:'dotted', color: {argb: 'FFCCCCCC'}}, bottom: {style:'dotted', color: {argb: 'FFCCCCCC'}} };
                        }
                    }
                });
            });

            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            saveAs(blob, `Bieu-Do-Phan-Ca-${new Date().toISOString().slice(0,10)}.xlsx`);
            
            exportExcelBtn.innerHTML = `‚úÖ ƒê√£ xu·∫•t Excel`;
            setTimeout(() => { exportExcelBtn.innerHTML = `üìä Xu·∫•t Excel`; }, 3000);

        } catch (error) {
            console.error(error);
            alert("ƒê√£ x·∫£y ra l·ªói khi t·∫°o file Excel!");
            exportExcelBtn.innerHTML = `üìä Xu·∫•t Excel`;
        }
    });

    loginBtn.addEventListener('click', () => {
        if (!passwordInput.value.trim()) return;
        loginPopup.classList.add('hidden');
        mainContent.classList.add('visible');
        loadData(passwordInput.value.trim());
    });
    passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') loginBtn.click(); });
</script>
</body>
</html>
